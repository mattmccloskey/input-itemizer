var InputItemizer=new Class({Implements:[Options,Events],options:{name:"items",seperator:",",operator:":",min_input_width:80},initialize:function(t,e){this.setOptions(e),this.input=$(t).set("type","hidden"),this.options.name=this.input.get("name")||this.options.name,this.value=this.input.get("value"),this.values=[],this.element=new Element("div",{"class":"input-itemizer"}).inject(this.input,"before").addClass(this.input.get("class")),this.spacer=new Element("span",{"class":"input-itemizer-spacer",html:"&nbsp;",styles:{width:1}}).inject(this.element),this.value.length>0&&this.value.split(this.options.seperator).each(function(t){this.values.push(t),this.make_token(t)}.bind(this)),this.element.addEventListener("click",function(t){var e=$(t.target);e.hasClass("input-itemizer-remove")?(t.preventDefault(),this.remove_value(null,e.getParent(".input-itemizer-token"))):(t.preventDefault(),t.stopPropagation(),this.create_input())}.bind(this))},add_value:function(t){t=t.trim(),this.make_token(t),this.value=this.serialize(),this.input.set("value",this.value),this.fireEvent("newvalue",[t]),this.fireEvent("change")},remove_value:function(t,e){if("undefined"==typeof e){var i=this.getElements(".input-itemizer-token"),n=0,s=i.length;for(n;s>n;n++)if(i[n].retrieve("value")===t){e=i[n];break}}else t=e.retrieve("value");e.destroy(),this.value=this.serialize(),this.input.set("value",this.value),this.fireEvent("removevalue",[t]),this.fireEvent("change")},create_input:function(){return this.item_input?!1:(this.item_input=new Element("input",{type:"text",size:"1","class":"input-itemizer-input",styles:{width:this.options.min_input_width}}).inject(this.element),this.item_input_measure=new Element("span").inject(this.element),this.copyStyles(this.element,this.item_input),this.copyStyles(this.element,this.item_input_measure),this.item_input_measure.setStyles({position:"absolute",top:0,left:0,visibility:"hidden",padding:0}),this.item_input.addEvents({keydown:function(t){if([this.options.seperator,this.options.operator].contains(t.key))return t.preventDefault(),!1;var e=$(t.target),i=["enter","up","down","left","right","backspace","delete","esc"].contains(t.key)?"":t.key;"space"===t.key&&(i="&nbsp;"),this.item_input_measure.set("html",this.item_input.get("value").replace(" ","&nbsp;")+i+i),e.setStyle("width",Math.max(this.options.min_input_width,Math.min(this.item_input_measure.getSize().x+this.item_input.getStyle("padding-left").toInt()+this.item_input.getStyle("padding-right").toInt(),this.element.getSize().x-this.element.getStyle("padding-left").toInt()-this.element.getStyle("padding-right").toInt()-this.item_input.getStyle("margin-left").toInt()-this.item_input.getStyle("margin-right").toInt()))),"enter"===t.key||"tab"===t.key?(t.stop(),""!==e.get("value")&&this.add_value(e.get("value")),e.set("value","").setStyle("width",this.options.min_input_width)):"backspace"!==t.key&&"delete"!==t.key||0!==e.get("value").length||(t.stop(),this.remove_input())}.bind(this),keypress:function(t){[this.options.seperator,this.options.operator].contains(t.key)&&t.preventDefault()}.bind(this),blur:function(){this.fireEvent("inputblur",[this.item_input.get("value")]),this.remove_input()}.bind(this)}),this.itemizer_remove_input||(this.itemizer_remove_input=this.remove_input.bind(this),$(document.body).addEvent("click",this.itemizer_remove_input)),this.item_input.focus(),void this.fireEvent("addinput",[this.input]))},remove_input:function(){this.item_input&&(this.item_input.destroy(),this.item_input_measure.destroy(),this.item_input=!1),$(document.body).removeEvent("click",this.itemizer_remove_input),this.itemizer_remove_input=!1},make_token:function(t){{var e=t.split(this.options.operator),t=e[0],i=e.length>1?e[1]:t,n=new Element("span",{"class":"input-itemizer-token",html:'<span class="input-itemizer-value">'+i+"</span>"}).inject(this.item_input?this.item_input:this.element,this.item_input?"before":"bottom").store("value",t);new Element("a",{href:"#","class":"input-itemizer-remove",html:"&times;"}).inject(n)}},serialize:function(){var t="";return this.element.getElements(".input-itemizer-token").each(function(e){t.length>0&&(t+=this.options.seperator),t+=e.retrieve("value")}.bind(this)),t},copyStyles:function(t,e,i){return i=i||["padding","font-weight","font-family","font-style","font-size","line-height","border"],i.each(function(i){e.setStyle(i,t.getStyle(i))}.bind(this)),i["font-family"]&&(e.style.fontFamily=t.getStyle("font-family")),this}});